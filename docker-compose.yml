version: "3.9"

services:
  app:
    # optional container for parity; in dev you will usually run `shopify app dev` locally
    build: ./app
    ports: ["3000:3000"]
    env_file: [app/.env]
    volumes:
      - ./app:/app
    profiles: ["full"]
    restart: unless-stopped

  backend:
    build: ./backend
    ports: ["8000:8000"]
    env_file: [backend/.env]
    volumes:
      - ./backend:/app
    profiles: ["cpu", "gpu", "full"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G

  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    ports: ["9000:9000"]
    env_file: [worker/.env]
    volumes:
      - ./worker:/app
    profiles: ["cpu", "full"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G

  worker-gpu:
    build:
      context: ./worker
      dockerfile: Dockerfile.gpu
    ports: ["9000:9000"]
    env_file: [worker/.env]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
        limits:
          cpus: "4"
          memory: 8G
    # Docker Desktop on Windows with WSL usually handles GPU without setting runtime
    # uncomment if needed:
    # runtime: nvidia
    volumes:
      - ./worker:/app
    profiles: ["gpu"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
